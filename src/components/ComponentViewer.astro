<component-viewer>
  <div class="component-viewer">
    <div class="component-wrapper">
      <iframe
        title="astrolab-preview-iframe"
        src="/_astrolab/preview"
        allow="clipboard-write"
        allowfullscreen></iframe>
    </div>
  </div>
</component-viewer>

<style lang="scss">
  .component-viewer {
    width: 100%;
    height: calc(100vh - var(--control-bar-height));
  }

  .component-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: scroll;
  }

  iframe {
    display: block;
    width: 100%;
    height: 100%;
    border: none;
    margin: 0 auto;
    transition:
      width 200ms ease,
      height 200ms ease;

    &.mobile {
      width: 375px;
      height: 667px;
    }

    &.tablet {
      width: 768px;
      height: 1024px;
    }

    &.desktop {
      width: 1920px;
      height: 1080px;
    }
  }
</style>

<script>
  class ComponentViewer extends HTMLElement {
    componentViewer: HTMLElement | null = null;
    componentWrapper: HTMLDivElement | null = null;
    iframe: HTMLIFrameElement | null = null;
    zoom: number = 1;

    connectedCallback() {
      this.componentViewer = this.querySelector('.component-viewer');
      this.componentWrapper = this.querySelector('.component-wrapper');
      this.iframe = this.querySelector('iframe');

      document.addEventListener('component-updated', () => {
        this.iframe?.contentWindow?.location.reload();
      });

      document.addEventListener('toggle-grid', () => {
        this.iframe?.contentDocument
          ?.querySelector('body')
          ?.classList.toggle('grid-lines');
      });

      document.addEventListener('zoom-in', () => {
        this.zoom += 0.1;
        this.#applyZoom();
      });

      document.addEventListener('zoom-out', () => {
        this.zoom -= 0.1;
        this.#applyZoom();
      });

      document.addEventListener('zoom-reset', () => {
        this.zoom = 1;
        this.#applyZoom();
      });
    }

    #applyZoom() {
      const doc = this.iframe?.contentDocument;

      if (doc) {
        doc.documentElement.querySelector('body')!.style.transform =
          `scale(${Math.max(0.2, this.zoom)})`;
        doc.documentElement.querySelector('body')!.style.width =
          `${100 / Math.max(0.2, this.zoom)}%`;
        doc.documentElement.querySelector('body')!.style.height =
          `${100 / Math.max(0.2, this.zoom)}%`;
      }
    }
  }

  customElements.define('component-viewer', ComponentViewer);
</script>
